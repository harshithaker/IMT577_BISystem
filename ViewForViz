CREATE OR REPLACE SECURE VIEW VW_STATE_PERFORMANCE AS
(
SELECT DD.DATE, DD.DAY_NAME,DD.YEAR, DD.MONTH_NAME, DL.STATE_PROVINCE, X.STORE_COUNT,
DP.PRODUCT_NAME, DP.PRODUCT_TYPE, DP.PRODUCT_CATEGORY,
SUM(FS.SALE_QUANTITY) AS QUANTITY, SUM(FS.SALE_AMOUNT) AS SALE, SUM(FS.SALE_TOTAL_PROFIT) AS PROFIT
FROM FACT_SALES FS
INNER JOIN DIM_STORE DS ON FS.DIM_STORE_ID = DS.DIM_STORE_ID
INNER JOIN DIM_LOCATION DL ON DS.DIM_LOCATION_ID = DL.DIM_LOCATION_ID
INNER JOIN DIM_DATE DD ON FS.DATE_PKEY = DD.DATE_PKEY
INNER JOIN DIM_PRODUCT DP ON FS.DIM_PRODUCT_ID = DP.DIM_PRODUCT_ID
INNER JOIN 
(
SELECT DL.STATE_PROVINCE, COUNT(DS.STORE_NUMBER) STORE_COUNT
FROM DIM_STORE DS
INNER JOIN DIM_LOCATION DL ON DS.DIM_LOCATION_ID = DL.DIM_LOCATION_ID
WHERE DL.STATE_PROVINCE != 'UNKNOWN'  
GROUP BY DL.STATE_PROVINCE
) X ON DL.STATE_PROVINCE = X.STATE_PROVINCE
WHERE DL.STATE_PROVINCE != 'UNKNOWN'  
GROUP BY DD.DATE,  DD.DAY_NAME, DD.YEAR, DD.MONTH_NAME, DL.STATE_PROVINCE, X.STORE_COUNT,
DP.PRODUCT_NAME, DP.PRODUCT_TYPE, DP.PRODUCT_CATEGORY
);
